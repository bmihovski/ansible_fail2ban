---
# main playbook to call roles

- name: Apply new date parser and banaction for multics
  hosts: server1
  gather_facts: false
  roles:
    - fail2ban_regex_date_and_banaction
  vars:
    - create: false
    - test_it: false

- name: Apply sasl fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/mail.log
    - filter_name: postfix-sasl
    - create: false
    - test_it: false  

- name: Apply courierpop3 fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/mail.log
    - filter_name: courier-auth
    - create: false
    - test_it: false  

- name: Implement wp auth fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: wp_auth.conf
    - filter_regex: "^<HOST>.*.*\"POST /wp-login.php"
    - create: false
    - test_it: false
    - log_file_to_check: /var/log/apache2/vila-bojana.eu/access.log

- name: Apply wp auth rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/apache2/vila-bojana.eu/access.log
    - filter_name: wp_auth
    - create: false
    - test_it: false

- name: Implement wp auth rpc fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: wp_auth_rpc.conf
    - filter_regex: "^<HOST>.*.*\"POST /xmlrpc.php"
    - create: false
    - test_it: false
    - log_file_to_check: /var/log/apache2/vila-bojana.eu/access.log

- name: Apply wp auth rpc rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/apache2/vila-bojana.eu/access.log
    - filter_name: wp_auth_rpc
    - create: false
    - test_it: false


- name: Implement postfix unknown fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: postfix_unknown.conf
    - filter_regex: "^.*: connect from unknown\\[<HOST>\\]$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/log/syslog
    
- name: Apply postfix fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/syslog
    - filter_name: postfix_unknown
    - create: false
    - test_it: false
    
- name: Apply postfix RCPT from unknown fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/syslog
    - filter_name: postfix
    - create: false
    - test_it: false
    
- name: Apply named query (cache) denied fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/syslog
    - filter_name: named-refused
    - create: false
    - test_it: false

- name: Implement proftpd - FTP session closed fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: proftpd_closed.conf
    - filter_regex: "^.*: .* \\(.*\\[<HOST>\\]\\) - FTP session closed.$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/log/syslog
    
- name: Apply proftpd - FTP session closed fail2ban rule to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/syslog
    - filter_name: proftpd_closed
    - create: false
    - test_it: false
    
- name: Implement named DNS format error fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: named_format_error.conf
    - filter_regex: ".*: DNS format error from <HOST>#.*"
    - create: false
    - test_it: false
    - log_file_to_check: /var/log/syslog
    
- name: Apply named DNS format error to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/log/syslog
    - filter_name: named_format_error
    - create: false
    - test_it: false
   
- name: Implement multics cache fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cache.conf
    - filter_regex: ".*cache: Alert! unknown peer \\(<HOST>\\:.*\\)$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cache to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cache
    - create: false
    - test_it: false
    
- name: Implement multics cccam wrong sha1 fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_sha1.conf
    - filter_regex: ".*wrong sha1 hash from client! \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam wrong sha1 to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_sha1
    - create: false
    - test_it: false
 
- name: Implement multics cccam connection refused fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_con_ref.conf
    - filter_regex: ".*connection refused for client .* \\(<HOST>\\), client disabled$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam connection refused to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_con_ref
    - create: false
    - test_it: false

- name: Implement multics cccam Unknown Client fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_unknown_cl.conf
    - filter_regex: ".*Unknown Client '.*' \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam Unknown Client to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_unknown_cl
    - create: false
    - test_it: false
    
- name: Implement multics cccam ip refused fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_ip_refused.conf
    - filter_regex: ".*: Aborted connection from Client '.*' \\(<HOST>\\), ip refused$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam ip refused to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_ip_refused
    - create: false
    - test_it: false

- name: Implement multics cccam already connected fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_alrdy_con.conf
    - filter_regex: ".*Client .* \\(<HOST>\\) already connected with different ip$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam already connected to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_alrdy_con
    - create: false
    - test_it: false

- name: Implement multics cccam failed connect fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_failed_con.conf
    - filter_regex: ".*Failed to connect new client\\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam failed connect to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_failed_con
    - create: false
    - test_it: false

- name: Implement multics cccam login failed fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_login_fail.conf
    - filter_regex: ".*login failed from client\\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam login failed to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_login_fail
    - create: false
    - test_it: false

- name: Implement multics cccam ip temporary blocked fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cccam_ip_tmp_blk.conf
    - filter_regex: ".*: New Connection \\(<HOST>\\) closed, ip temporary blocked$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cccam ip temporary blocked to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cccam_ip_tmp_blk
    - create: false
    - test_it: false

- name: Implement multics mgcamd New Connection fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_new_con.conf
    - filter_regex: ".*mgcamd: New Connection \\(<HOST>\\) closed, ip blocked$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd New Connection to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_new_con
    - create: false
    - test_it: false

- name: Implement multics mgcamd wrong des key fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_des_key.conf
    - filter_regex: ".*mgcamd: \\(<HOST>\\) new connection closed, wrong des key$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd wrong des key to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_des_key
    - create: false
    - test_it: false

- name: Implement multics mgcamd new connection closed fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_con_clos.conf
    - filter_regex: ".*mgcamd: \\(<HOST>\\) new connection closed, receive timeout$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd new connection closed to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_con_clos
    - create: false
    - test_it: false

- name: Implement multics mgcamd wrong username fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_wrng_user.conf
    - filter_regex: ".*newcamd: wrong username length \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd wrong username to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_wrng_user
    - create: false
    - test_it: false

- name: Implement multics mgcamd connection refused fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_con_ref.conf
    - filter_regex: ".*mgcamd: connection refused for client '.*' \\(<HOST>\\), client disabled$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd connection refused to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_con_ref
    - create: false
    - test_it: false

- name: Implement multics mgcamd unknown user fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_unkn_user.conf
    - filter_regex: ".*mgcamd: unknown user .* \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd unknown usern to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_unkn_user
    - create: false
    - test_it: false

- name: Implement multics mgcamd user already connected fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_alr_con.conf
    - filter_regex: ".*mgcamd: user already connected .* \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd user already connected to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_alr_con
    - create: false
    - test_it: false

- name: Implement multics mgcamd ip refused fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_mgcamd_ip_refus.conf
    - filter_regex: ".*mgcamd: Client '.*' \\(<HOST>\\), ip refused$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics mgcamd ip refused to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_mgcamd_ip_refus
    - create: false
    - test_it: false
    
- name: Implement multics newcamd wrong des key fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_wrng_des.conf
    - filter_regex: ".*\\(<HOST>\\) new connection closed, wrong des key$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd wrong des key to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_wrng_des
    - create: false
    - test_it: false

- name: Implement multics newcamd new connection closed fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_con_clos.conf
    - filter_regex: ".*\\(<HOST>\\) new connection closed, receive timeout$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd new connection closed to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_con_clos
    - create: false
    - test_it: false
    
- name: Implement multics newcamd new connection closed, wrong username fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_con_user.conf
    - filter_regex: ".*\\(<HOST>\\) new connection closed, wrong username length$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd new connection closed, wrong username to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_con_user
    - create: false
    - test_it: false
    
- name: Implement multics newcamd new connection closed, unknown user fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_con_ukn.conf
    - filter_regex: ".*\\(<HOST>\\) new connection closed, unknown user '.*'$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd new connection closed, unknown user to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_con_ukn
    - create: false
    - test_it: false
    
- name: Implement multics newcamd user already connected fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_alrd_con.conf
    - filter_regex: ".*user already connected .* \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd user already connected to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_alrd_con
    - create: false
    - test_it: false
 
- name: Implement multics newcamd wrong pass fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_wrg_pass.conf
    - filter_regex: ".*client .* wrong password \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd wrong pass to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_wrg_pass
    - create: false
    - test_it: false
- name: Implement multics newcamd unknown user fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_newcamd_unk_user.conf
    - filter_regex: ".*unknown user .* \\(<HOST>.*$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics newcamd unknown user to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_newcamd_unk_user
    - create: false
    - test_it: false
    
- name: Implement multics camd35 client disabled fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_camd_clnt_disabl.conf
    - filter_regex: ".*camd35: connection refused for client '.*' \\(<HOST>\\), client disabled$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics camd35 client disabled to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_camd_clnt_disabl
    - create: false
    - test_it: false
    
- name: Implement multics cs378x client disabled fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cs378x_clnt_dis.conf
    - filter_regex: ".*cs378x: connection refused for client '.*' \\(<HOST>\\), client disabled$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cs378x client disabled to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cs378x_clnt_dis
    - create: false
    - test_it: false
    
- name: Implement multics cs378x ip blocked fail2ban rule
  hosts: server1
  gather_facts: false
  roles:
    - create_filter
  vars:
    - filter_conf: multics_cs378x_ip_block.conf
    - filter_regex: ".*cs378x: New Connection \\(<HOST>\\) closed, ip blocked$"
    - create: false
    - test_it: false
    - log_file_to_check: /var/tmp/multics.log
    
- name: Apply multics cs378x ip blocked to jail conf
  hosts: server1
  gather_facts: false
  roles:
    - append_to_jail
  vars:
    - jail_conf_file: jail.conf
    - log_file_to_check: /var/tmp/multics.log
    - filter_name: multics_cs378x_ip_block
    - create: false
    - test_it: false
...